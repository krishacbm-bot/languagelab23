<!DOCTYPE html>
<html>
<head>
    <title>Offline Pronunciation Trainer</title>
    <style>
        body { font-family: Arial; text-align: center; margin-top: 50px; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; }
        #status { font-weight: bold; margin-top: 20px; }
        #result { margin-top: 20px; white-space: pre-line; font-size: 18px; }
    </style>
</head>
<body>

<h2>ðŸŽ¤ Offline Pronunciation Trainer</h2>

<button onclick="startRecording()">Start Recording</button>
<button onclick="stopRecording()">Stop & Submit</button>

<p id="status"></p>
<p id="result">Your spoken text will appear here...</p>

<script>
let mediaRecorder;
let audioChunks = [];
let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.start();
    document.getElementById("status").innerText = "ðŸŽ™ Recording...";
}

function stopRecording() {
    mediaRecorder.stop();
    mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const arrayBuffer = await blob.arrayBuffer();
        const buffer = await audioCtx.decodeAudioData(arrayBuffer);

        // Convert AudioBuffer to WAV
        function encodeWAV(buffer) {
            const numChan = buffer.numberOfChannels;
            const len = buffer.length * numChan * 2 + 44;
            const ab = new ArrayBuffer(len);
            const view = new DataView(ab);
            let offset = 0;
            function writeStr(s){for(let i=0;i<s.length;i++)view.setUint8(offset+i,s.charCodeAt(i));offset+=s.length;}
            writeStr('RIFF');
            view.setUint32(offset,len-8,true); offset+=4;
            writeStr('WAVEfmt ');
            view.setUint32(offset,16,true); offset+=4;
            view.setUint16(offset,1,true); offset+=2;
            view.setUint16(offset,numChan,true); offset+=2;
            view.setUint32(offset,buffer.sampleRate,true); offset+=4;
            view.setUint32(offset,buffer.sampleRate*2*numChan,true); offset+=4;
            view.setUint16(offset,numChan*2,true); offset+=2;
            view.setUint16(offset,16,true); offset+=2;
            writeStr('data');
            view.setUint32(offset,len-44,true); offset+=4;

            const ch = buffer.getChannelData(0);
            let pos = offset;
            for(let i=0;i<ch.length;i++,pos+=2){
                let s = Math.max(-1,Math.min(1,ch[i]));
                view.setInt16(pos,s<0?s*0x8000:s*0x7FFF,true);
            }
            return new Blob([view],{type:'audio/wav'});
        }

        const wavBlob = encodeWAV(buffer);

        const formData = new FormData();
        formData.append("audio", wavBlob, "student.wav");

        const res = await fetch("/evaluate",{ method:"POST", body: formData });
        const data = await res.json();

        document.getElementById("status").innerText = "âœ… Submitted!";
        document.getElementById("result").innerText =
            `ðŸŽ¤ You said: ${data.spoken}\nðŸ”Š Correct pronunciation: ${data.correct_pronunciation}\nðŸ“Š Score: ${data.score}%`;
    };
}
</script>

</body>
</html>
