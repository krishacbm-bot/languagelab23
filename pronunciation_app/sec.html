<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Speak or Type ‚Üí Get Corrected Sentence</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 30px; }
    textarea { width: 90%; max-width: 800px; height: 90px; font-size: 16px; padding: 8px; }
    button, select { padding: 10px 14px; font-size: 15px; margin: 8px; cursor: pointer; }
    #original, #corrected { margin-top: 12px; font-size: 18px; }
    .label { font-weight: bold; margin-top: 18px; display:block; }
    .correct { color: green; font-weight: bold; }
    .original { color: #333; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>üé§ Speak or Type ‚Äî Get Corrected Sentence</h2>

  <div>
    <button id="startSpeak">üî¥ Start Speaking</button>
    <button id="stopSpeak" disabled>‚èπ Stop</button>
  </div>

  <label class="label">Or type your sentence here:</label>
  <textarea id="inputText" placeholder="Type a sentence or speak and it will appear here..."></textarea>
  <div>
    <button id="correctBtn">‚úÖ Correct</button>
    <button id="playCorrected" disabled>üîâ Play Corrected</button>
    <select id="voiceRate" title="Speech speed">
      <option value="0.8">Slow</option>
      <option value="1" selected>Normal</option>
      <option value="1.3">Fast</option>
    </select>
  </div>

  <div id="original"><span class="label">Original:</span><div class="original" id="origText">‚Äî</div></div>
  <div id="corrected"><span class="label">Corrected:</span><div class="correct" id="corrText">‚Äî</div></div>
  <div id="message"></div>

  <script>
    // Elements
    const startBtn = document.getElementById('startSpeak');
    const stopBtn = document.getElementById('stopSpeak');
    const inputText = document.getElementById('inputText');
    const correctBtn = document.getElementById('correctBtn');
    const playBtn = document.getElementById('playCorrected');
    const origText = document.getElementById('origText');
    const corrText = document.getElementById('corrText');
    const message = document.getElementById('message');
    const voiceRate = document.getElementById('voiceRate');

    let recognition, speaking = false;
    let lastCorrected = '';

    // SpeechRecognition setup (may be webkitSpeechRecognition)
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if (SpeechRec === null) {
      startBtn.disabled = true;
      stopBtn.disabled = true;
      message.innerHTML = '<span class="error">Speech recognition not supported in this browser.</span>';
    } else {
      recognition = new SpeechRec();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        speaking = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        message.innerText = 'Listening... Speak now.';
      };

      recognition.onresult = (evt) => {
        const spoken = evt.results[0][0].transcript;
        inputText.value = spoken;
        origText.innerText = spoken;
        message.innerText = 'Captured. Click Correct to get a corrected version.';
      };

      recognition.onerror = (evt) => {
        message.innerHTML = '<span class="error">Speech recognition error: ' + (evt.error || 'unknown') + '</span>';
      };

      recognition.onend = () => {
        speaking = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        if (message.innerText === 'Listening... Speak now.') message.innerText = 'Stopped listening.';
      };
    }

    startBtn.addEventListener('click', () => {
      if (!recognition) return;
      try {
        recognition.start();
      } catch(e) {
        // Some browsers throw if start called too soon ‚Äî ignore
      }
    });

    stopBtn.addEventListener('click', () => {
      if (!recognition) return;
      recognition.stop();
    });

    // Basic helper to call LanguageTool public endpoint for grammar suggestions
    async function callLanguageTool(text) {
      // Uses the free public LanguageTool.org endpoint
      const params = new URLSearchParams();
      params.append('language', 'en-US');
      params.append('text', text);
      // The public endpoint is rate-limited; for heavy use host your own or use a paid plan.
      const resp = await fetch('https://api.languagetool.org/v2/check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      });
      if (!resp.ok) throw new Error('LanguageTool request failed: ' + resp.status);
      return resp.json();
    }

    // Apply LanguageTool replacements to produce corrected string
    function applyReplacements(original, matches) {
      // process reversed so offsets remain valid as we replace
      let corrected = original;
      matches.sort((a,b)=> (b.offset - a.offset));
      matches.forEach(m => {
        if (m.replacements && m.replacements.length > 0) {
          const r = m.replacements[0].value;
          corrected = corrected.slice(0, m.offset) + r + corrected.slice(m.offset + m.length);
        }
      });
      return corrected;
    }

    // Button: Correct
    correctBtn.addEventListener('click', async () => {
      const txt = inputText.value.trim();
      if (!txt) {
        message.innerHTML = '<span class="error">Please type or speak a sentence first.</span>';
        return;
      }
      message.innerText = 'Checking grammar...';
      origText.innerText = txt;

      try {
        const res = await callLanguageTool(txt);
        // If LanguageTool returned matches, apply them to get corrected sentence
        let corrected = applyReplacements(txt, res.matches || []);
        // If LanguageTool didn't change anything, still try small fixes:
        if (corrected.trim().length === 0) corrected = txt;
        // Capitalize first letter and ensure punctuation at end (small cleanup)
        corrected = corrected.trim();
        corrected = corrected.charAt(0).toUpperCase() + corrected.slice(1);
        if (!/[.!?]$/.test(corrected)) corrected += '.';

        corrText.innerText = corrected;
        lastCorrected = corrected;
        playBtn.disabled = false;
        message.innerText = 'Corrected ‚Äî you can play it aloud or edit the corrected sentence.';
      } catch (err) {
        console.error(err);
        message.innerHTML = '<span class="error">Error during correction: ' + err.message + '</span>';
      }
    });

    // Button: Play corrected sentence
    playBtn.addEventListener('click', () => {
      if (!lastCorrected) return;
      const u = new SpeechSynthesisUtterance(lastCorrected);
      u.lang = 'en-US';
      u.rate = parseFloat(voiceRate.value) || 1;
      speechSynthesis.speak(u);
    });

    // Update original display as user types
    inputText.addEventListener('input', () => {
      origText.innerText = inputText.value || '‚Äî';
    });
  </script>
</body>
</html>
