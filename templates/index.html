<!DOCTYPE html>
<html>
<head>
  <title>Offline Pronunciation Trainer</title>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 50px; }
    #sentence { font-size: 22px; font-weight: bold; margin: 20px; }
    #result { font-size: 18px; margin-top: 20px; white-space: pre-line; }
    button { padding: 10px 20px; font-size: 16px; margin: 5px; }
  </style>
</head>
<body>

<h2>ðŸŽ¤ Offline Pronunciation Trainer</h2>

<p id="sentence">Click "New Sentence"</p>
<button onclick="getSentence()">New Sentence</button>
<br><br>

<button onclick="startRecording()">Start Recording</button>
<button onclick="stopRecording()">Stop & Submit</button>

<p id="status"></p>
<p id="result"></p>

<script>
let sentence = "";
let mediaRecorder;
let audioChunks = [];

async function getSentence() {
    const res = await fetch("/get_sentence");
    const data = await res.json();
    sentence = data.sentence;
    document.getElementById("sentence").innerText = sentence;

    // Speak sentence via browser TTS
    let msg = new SpeechSynthesisUtterance(sentence);
    window.speechSynthesis.speak(msg);
}

async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.start();
    document.getElementById("status").innerText = "ðŸŽ™ Recording...";
}

function stopRecording() {
    mediaRecorder.stop();
    mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const arrayBuffer = await blob.arrayBuffer();
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        // Convert to 16-bit WAV
        function encodeWAV(audioBuffer) {
            const numOfChan = audioBuffer.numberOfChannels;
            const length = audioBuffer.length * numOfChan * 2 + 44;
            const buffer = new ArrayBuffer(length);
            const view = new DataView(buffer);

            let offset = 0;
            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
                offset += str.length;
            }

            writeString('RIFF');
            view.setUint32(offset, length - 8, true); offset += 4;
            writeString('WAVE');
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint16(offset, numOfChan, true); offset += 2;
            view.setUint32(offset, audioBuffer.sampleRate, true); offset += 4;
            view.setUint32(offset, audioBuffer.sampleRate * 2 * numOfChan, true); offset += 4;
            view.setUint16(offset, numOfChan * 2, true); offset += 2;
            view.setUint16(offset, 16, true); offset += 2;
            writeString('data');
            view.setUint32(offset, length - offset - 4, true); offset += 4;

            const channelData = audioBuffer.getChannelData(0); // mono
            let pos = offset;
            for (let i = 0; i < channelData.length; i++, pos += 2) {
                let sample = Math.max(-1, Math.min(1, channelData[i]));
                view.setInt16(pos, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        const wavBlob = encodeWAV(audioBuffer);

        // Send to Flask backend
        const formData = new FormData();
        formData.append("audio", wavBlob, "student.wav");
        formData.append("correct_sentence", sentence);

        const res = await fetch("/evaluate", { method: "POST", body: formData });
        const data = await res.json();

        document.getElementById("status").innerText = "âœ… Submitted!";
        document.getElementById("result").innerText =
            `You said: ${data.spoken}\nScore: ${data.score}% â†’ ${data.result}`;

        // Speak correct pronunciation if wrong
        if (data.result.includes("Try Again")) {
            let msg = new SpeechSynthesisUtterance(data.correct_sentence);
            window.speechSynthesis.speak(msg);
        }
    };
}
</script>

</body>
</html>
